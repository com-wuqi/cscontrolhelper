name: Publish Docker Image to GHCR

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: com-wuqi/cscontrolhelper  # å…¨å°å†™
  LOCAL_IMAGE: cscontrolhelper:test      # æœ¬åœ°æµ‹è¯•é•œåƒå

jobs:
  build-test-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write  # å…³é”®ï¼šå…è®¸å†™å…¥åŒ…
      id-token: write  # ç”¨äº OIDC è®¤è¯

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}  # è‡ªåŠ¨ä½¿ç”¨ GitHub Token

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,format=long,prefix=
          flavor: |
            latest=auto

      # å…³é”®ä¿®æ­£1ï¼šå…ˆæ„å»ºæœ¬åœ°é•œåƒç”¨äºæµ‹è¯•
      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false  # ä»…æ„å»ºä¸æ¨é€
          tags: ${{ env.LOCAL_IMAGE }}
          outputs: type=docker,dest=/tmp/image.tar

      # å…³é”®ä¿®æ­£2ï¼šä½¿ç”¨æœ¬åœ°é•œåƒæµ‹è¯•ï¼ˆæ— éœ€ç½‘ç»œæƒé™ï¼‰
      - name: Test container startup
        run: |
          # åŠ è½½æœ¬åœ°é•œåƒ
          docker load -i /tmp/image.tar
          
          echo "ğŸš€ Starting container from local image: ${{ env.LOCAL_IMAGE }}"
          
          # è¿è¡Œå®¹å™¨
          docker run -d \
            --name test-app \
            -p 8000:8000 \
            "${{ env.LOCAL_IMAGE }}"
          
          # ç­‰å¾…åˆå§‹åŒ–
          echo "â³ Waiting for application to start (max 30s)..."
          timeout=30
          while ! curl -s http://localhost:8000/health > /dev/null 2>&1; do
            timeout=$((timeout-1))
            if [ $timeout -le 0 ]; then
              echo "âŒ Application failed to start within 30 seconds"
              echo "ğŸ” Container logs:"
              docker logs test-app || true
              echo "ğŸ” Process list:"
              docker exec test-app ps aux || true
              exit 1
            fi
            echo "â³ Waiting... ($timeout seconds left)"
            sleep 1
          done
          
          echo "âœ… Health check passed!"
          curl -v http://localhost:8000/health
          
          # æ¸…ç†
          docker stop test-app
          docker rm test-app
        shell: bash

      # å…³é”®ä¿®æ­£3ï¼šæµ‹è¯•æˆåŠŸåæ‰æ¨é€
      - name: Push Docker image to GHCR
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max